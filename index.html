<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Serial Scanner PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui,Arial;
  background:#020617;
  color:white;
  padding:12px;
  padding-bottom:90px;
}
h2{margin:6px 0}
small{color:#94a3b8}

.camera{
  position:relative;
  overflow:hidden;
  border-radius:16px;
}
video{
  width:100%;
  height:55vh;
  object-fit:cover;
  border-radius:16px;
  background:#000;
}
.scan-box{
  position:absolute;
  top:40%;
  left:10%;
  width:80%;
  height:15%;
  border:3px dashed #22c55e;
  border-radius:12px;
  box-shadow:0 0 0 99999px rgba(0,0,0,0.55);
  pointer-events:none;
}
.scan-status{
  position:absolute;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,0.85);
  padding:10px 18px;
  border-radius:20px;
  font-size:14px;
  font-weight:700;
}

.card{
  background:#0f172a;
  border-radius:14px;
  padding:12px;
  margin-top:10px;
  border:2px solid #1e293b;
}

input{
  width:100%;
  font-size:22px;
  padding:12px;
  border-radius:10px;
  border:2px solid #22c55e;
  text-align:center;
  letter-spacing:3px;
  text-transform:uppercase;
  background:#0f172a;
  color:white;
}

button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
}
.start,.save{background:#22c55e;color:black}
.retry{background:#facc15}
.manual{background:#38bdf8}
.download{background:#8b5cf6;color:white;margin-top:14px}
.mode{background:#1e293b;color:white}

.stats{
  display:flex;
  gap:8px;
  margin-top:12px;
}
.stats div{
  flex:1;
  background:#1e293b;
  border-radius:10px;
  padding:10px;
  text-align:center;
  border:2px solid #334155;
}
.stats b{font-size:22px}

.table-container{
  overflow-x:auto;
  margin-top:12px;
  background:#0f172a;
  border-radius:10px;
  border:2px solid #1e293b;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  border:1px solid #334155;
  padding:8px;
}
th{background:#1e293b}

.valid{background:#dcfce7;color:#14532d}
.invalid{background:#fee2e2;color:#7f1d1d}

@keyframes scan{0%,100%{opacity:1}50%{opacity:.3}}
.scanning{animation:scan 1.4s infinite}
</style>
</head>

<body>

<h2>üì∑ Scan Nomor Seri</h2>
<small>Format: 1 Huruf + 10 Angka</small>

<button class="start" onclick="startCamera()">‚ñ∂ Aktifkan Kamera</button>
<button class="mode" onclick="toggleMode()">‚öô Mode: <span id="modeText">ACCURATE</span></button>

<div class="camera" id="camera" style="display:none">
  <video id="video" playsinline muted></video>
  <div class="scan-box"></div>
  <div class="scan-status" id="status">üîç Scanning...</div>
</div>

<canvas id="canvas" hidden></canvas>

<div class="card" id="result" style="display:none">
  <input id="serial" maxlength="11">
  <button class="save" onclick="save()">‚úî Simpan</button>
  <button class="retry" onclick="retry()">üîÑ Scan Ulang</button>
  <button class="manual" onclick="edit()">‚úç Edit Manual</button>
</div>

<div class="stats">
  <div>Total<b id="t">0</b></div>
  <div>Valid<b id="v">0</b></div>
  <div>Invalid<b id="i">0</b></div>
</div>

<div class="table-container">
<table>
<thead><tr><th>No</th><th>Serial</th><th>Status</th><th>Waktu</th></tr></thead>
<tbody id="tbody"><tr><td colspan="4" align="center">Belum ada data</td></tr></tbody>
</table>
</div>

<button class="download" onclick="download()">‚¨á Download Excel</button>

<script>
// ================= GLOBAL =================
let SCAN_MODE="ACCURATE";
let scanBuffer={}, scanCount=0;
const MAX_FAST=2, MAX_ACC=4;

let data=JSON.parse(localStorage.getItem("scanData"))||[];
let no=data.length+1;
let stat={
  total:data.length,
  valid:data.filter(d=>d.Status==="VALID").length,
  invalid:data.filter(d=>d.Status==="INVALID").length
};

let stream, scanning=false, current=null;
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const status=document.getElementById("status");

// ================= UTIL =================
function normalize(t){
  return t.toUpperCase()
  .replace(/O/g,"0").replace(/[IL]/g,"1")
  .replace(/S/g,"5").replace(/B/g,"8")
  .replace(/[^A-Z0-9]/g,"");
}
function validSerial(s){return /^[A-Z]\d{10}$/.test(s);}

// ================= MODE =================
function toggleMode(){
  SCAN_MODE=SCAN_MODE==="FAST"?"ACCURATE":"FAST";
  document.getElementById("modeText").textContent=SCAN_MODE;
}

// ================= CAMERA =================
async function startCamera(){
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject=stream;
  await video.play();
  document.getElementById("camera").style.display="block";
  autoScan();
}
function stopCamera(){
  stream?.getTracks().forEach(t=>t.stop());
}

// ================= PREPROCESS =================
function preprocess(ctx,w,h){
  const img=ctx.getImageData(0,0,w,h);
  const d=img.data;
  let min=255,max=0;
  for(let i=0;i<d.length;i+=4){
    let g=d[i]*0.299+d[i+1]*0.587+d[i+2]*0.114;
    d[i]=d[i+1]=d[i+2]=g;
    min=Math.min(min,g);max=Math.max(max,g);
  }
  let s=255/(max-min||1);
  for(let i=0;i<d.length;i+=4){
    let v=(d[i]-min)*s;
    d[i]=d[i+1]=d[i+2]=v>140?255:0;
  }
  ctx.putImageData(img,0,0);
}
function isBlurry(ctx,w,h){
  const d=ctx.getImageData(0,0,w,h).data;
  let m=0,c=0;
  for(let i=0;i<d.length;i+=4){m+=d[i];c++}
  m/=c;
  let v=0;
  for(let i=0;i<d.length;i+=4)v+=(d[i]-m)**2;
  return v/c<120;
}

// ================= OCR =================
let interval;
function autoScan(){
  interval=setInterval(()=>!scanning&&scan(),1500);
}

async function scan(){
  scanning=true;
  const vw=video.videoWidth,vh=video.videoHeight;
  const sx=vw*0.1, sy=vh*0.4, sw=vw*0.8, sh=vh*0.15;
  canvas.width=sw; canvas.height=sh;
  ctx.drawImage(video,sx,sy,sw,sh,0,0,sw,sh);

  if(isBlurry(ctx,sw,sh)){scanning=false;return;}
  preprocess(ctx,sw,sh);

  const {data}=await Tesseract.recognize(canvas,"eng",{
    tessedit_char_whitelist:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
    tessedit_pageseg_mode:Tesseract.PSM.SINGLE_LINE,
    logger:()=>{}
  });

  const avg=data.symbols.reduce((a,b)=>a+b.confidence,0)/(data.symbols.length||1);
  if(avg<(SCAN_MODE==="FAST"?60:75)){scanning=false;return;}

  const m=normalize(data.text).match(/[A-Z]\d{10}/);
  if(m) scanBuffer[m[0]]=(scanBuffer[m[0]]||0)+1;
  scanCount++;

  const limit=SCAN_MODE==="FAST"?MAX_FAST:MAX_ACC;
  if(scanCount>=limit){
    const best=Object.entries(scanBuffer).sort((a,b)=>b[1]-a[1])[0];
    if(best){
      current=best[0];
      document.getElementById("serial").value=current;
      document.getElementById("result").style.display="block";
      stopCamera(); clearInterval(interval);
    }
    scanBuffer={}; scanCount=0;
  }
  scanning=false;
}

// ================= SAVE =================
function save(){
  const v=document.getElementById("serial").value;
  const ok=validSerial(v);
  data.push({No:no++,Serial:v,Status:ok?"VALID":"INVALID",Waktu:new Date().toLocaleString("id-ID")});
  localStorage.setItem("scanData",JSON.stringify(data));
  stat.total++; ok?stat.valid++:stat.invalid++;
  render(); retry();
}
function retry(){document.getElementById("result").style.display="none"; startCamera();}
function edit(){document.getElementById("serial").disabled=false;}

// ================= TABLE =================
function render(){
  document.getElementById("t").textContent=stat.total;
  document.getElementById("v").textContent=stat.valid;
  document.getElementById("i").textContent=stat.invalid;
  const tb=document.getElementById("tbody");
  tb.innerHTML="";
  data.slice(-30).reverse().forEach(d=>{
    tb.innerHTML+=`<tr><td>${d.No}</td><td>${d.Serial}</td><td>${d.Status}</td><td>${d.Waktu}</td></tr>`;
  });
}
render();

// ================= EXCEL =================
function download(){
  const valid=data.filter(d=>d.Status==="VALID").map(d=>d.Serial).join(",");
  const ws=XLSX.utils.aoa_to_sheet([["Rekapitulasi Arsip"],[],["Nomor Seri"],[valid]]);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Rekap");
  XLSX.writeFile(wb,"Rekapitulasi_Arsip.xlsx");
}
</script>

</body>
</html>
