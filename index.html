<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Serial Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui,Arial;
  background:#020617;
  color:white;
  padding:12px;
}
h2{margin:6px 0}
small{color:#94a3b8}

.camera{position:relative}
video{
  width:100%;
  height:55vh;
  object-fit:cover;
  border-radius:16px;
}
.scan-box{
  position:absolute;
  top:40%;
  left:10%;
  width:80%;
  height:15%;
  border:3px dashed #22c55e;
  border-radius:12px;
}

.card{
  background:#0f172a;
  border-radius:14px;
  padding:12px;
  margin-top:10px;
}

input{
  width:100%;
  font-size:22px;
  padding:10px;
  border-radius:10px;
  border:2px solid #22c55e;
  text-align:center;
  letter-spacing:3px;
  text-transform:uppercase;
}

button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:10px;
  font-weight:700;
  font-size:15px;
}

.start{background:#22c55e;color:black}
.save{background:#22c55e;color:black}
.retry{background:#facc15;color:black}
.manual{background:#38bdf8;color:black}

.stats{
  display:flex;
  gap:6px;
  margin-top:10px;
}
.stats div{
  flex:1;
  background:#1e293b;
  border-radius:10px;
  padding:8px;
  text-align:center;
  font-size:13px;
}

table{
  width:100%;
  margin-top:12px;
  border-collapse:collapse;
  font-size:12px;
}
th,td{
  border:1px solid #334155;
  padding:6px;
}
th{background:#1e293b}

.valid{
  border:2px solid #22c55e!important;
  background:#dcfce7;
  color:#14532d;
}
.invalid{
  border:2px solid #ef4444!important;
  background:#fee2e2;
  color:#7f1d1d;
}
.locked{opacity:0.7}
</style>
</head>

<body>

<h2>üì∑ Scan Nomor Seri</h2>
<small>Format: HURUF + 10 ANGKA (11 karakter)</small>

<button class="start" onclick="startCamera()">‚ñ∂Ô∏è Aktifkan Kamera</button>

<div class="camera">
  <video id="video" muted playsinline></video>
  <div class="scan-box"></div>
</div>

<canvas id="canvas" hidden></canvas>

<div class="card" id="result" style="display:none">
  <small>Hasil scan (bisa diedit)</small>
  <input id="serialInput" maxlength="11">
  <button class="save" onclick="save()">‚úî Simpan</button>
  <button class="manual" onclick="editManual()">‚úçÔ∏è Edit Manual</button>
  <button class="retry" onclick="retry()">üîÑ Scan Ulang</button>
</div>

<div class="stats">
  <div>üìä Total<br><b id="total">0</b></div>
  <div>‚úÖ Valid<br><b id="valid">0</b></div>
  <div>‚ùå Invalid<br><b id="invalid">0</b></div>
</div>

<table>
<thead>
<tr>
<th>No</th>
<th>Serial</th>
<th>Status</th>
<th>Waktu</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<button onclick="download()">‚¨áÔ∏è Download Excel</button>

<script>
let data=[], no=1;
let stat={total:0,valid:0,invalid:0};
let scanning=false, current=null;

const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const input=document.getElementById("serialInput");
const result=document.getElementById("result");

// ==== START CAMERA (WAJIB USER GESTURE) ====
function startCamera(){
  navigator.mediaDevices.getUserMedia({
    video:{ facingMode:{ ideal:"environment" } }
  }).then(stream=>{
    video.srcObject=stream;
    video.play();
  }).catch(e=>{
    alert("Kamera tidak bisa diakses: "+e.message);
  });
}

// ==== OCR OPTIMIZED ====
function normalize(t){
  return t.toUpperCase()
    .replace(/O/g,'0')
    .replace(/[IL]/g,'1')
    .replace(/S/g,'5')
    .replace(/Z/g,'2')
    .replace(/[^A-Z0-9]/g,'');
}

function validSerial(s){
  return /^[A-Z]\d{10}$/.test(s);
}

// scan tiap 2 detik (ringan)
async function scan(){
  if(scanning || current || video.readyState!==4) return;
  scanning=true;

  const vw=video.videoWidth, vh=video.videoHeight;
  const sx=vw*0.1, sy=vh*0.4, sw=vw*0.8, sh=vh*0.15;

  canvas.width=sw;
  canvas.height=sh;
  ctx.drawImage(video,sx,sy,sw,sh,0,0,sw,sh);

  const { data:o } = await Tesseract.recognize(canvas,"eng",{
    tessedit_char_whitelist:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
    tessedit_pageseg_mode:6
  });

  const cleaned=normalize(o.text);
  const match=cleaned.match(/[A-Z]\d{10}/);
  if(match){
    current=match[0];
    input.value=current;
    result.style.display="block";
  }
  scanning=false;
}

setInterval(scan,2000);

// ==== SAVE ====
function save(){
  const v=input.value.toUpperCase();
  stat.total++;

  const ok=validSerial(v);
  ok?stat.valid++:stat.invalid++;

  input.classList.remove("valid","invalid");
  input.classList.add(ok?"valid":"invalid","locked");
  input.disabled=true;

  const waktu=new Date().toLocaleString("id-ID");

  data.push({No:no,Serial:v,Status:ok?"VALID":"INVALID",Waktu:waktu});

  tbody.insertAdjacentHTML("beforeend",`
    <tr style="background:${ok?'#052e16':'#450a0a'}">
      <td>${no}</td>
      <td>${v}</td>
      <td>${ok?'‚úÖ VALID':'‚ùå INVALID'}</td>
      <td>${waktu}</td>
    </tr>
  `);

  no++;
  updateStat();
}

function retry(){
  current=null;
  result.style.display="none";
  input.disabled=false;
  input.value="";
  input.classList.remove("valid","invalid","locked");
}

function editManual(){
  input.disabled=false;
  input.focus();
}

function updateStat(){
  total.textContent=stat.total;
  valid.textContent=stat.valid;
  invalid.textContent=stat.invalid;
}

// ==== EXCEL FORMAT REKAPITULASI ====
function download(){
  const bulan="September";
  const tahun="2022";
  const lokasi="Bakauheni";

  const serialGabung=data.map(d=>d.Serial).join(",");

  const ws=XLSX.utils.aoa_to_sheet([
    ["Rekapitulasi Arsip"],
    [],
    [`Bulan : ${bulan}`,`Tahun : ${tahun}`,lokasi],
    [],
    ["Keterangan","Nomor Seri"],
    ["KI-D2",serialGabung]
  ]);

  ws["!merges"]=[{s:{r:0,c:0},e:{r:0,c:1}}];
  ws["!cols"]=[{wch:20},{wch:100}];

  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Rekapitulasi Arsip");
  XLSX.writeFile(wb,"Rekapitulasi_Arsip.xlsx");
}
</script>

</body>
</html>
